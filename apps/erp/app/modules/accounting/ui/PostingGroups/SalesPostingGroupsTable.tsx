import { useTranslation } from "@carbon/locale";
import type { ColumnDef } from "@tanstack/react-table";
import { useMemo } from "react";
import { Table } from "~/components";
import { EditableList } from "~/components/Editable";
import { Enumerable } from "~/components/Enumerable";
import type { ListItem } from "~/types";
import type { AccountListItem, SalesPostingGroup } from "../../types";
import usePostingGroups from "./usePostingGroups";

type SalesPostingGroupsTableProps = {
  data: SalesPostingGroup[];
  count: number;
  itemPostingGroups: ListItem[];
  customerTypes: ListItem[];
  balanceSheetAccounts: AccountListItem[];
  incomeStatementAccounts: AccountListItem[];
};

const SalesPostingGroupsTable = ({
  data,
  count,
  itemPostingGroups,
  customerTypes,
  balanceSheetAccounts,
  incomeStatementAccounts
}: SalesPostingGroupsTableProps) => {
  const { t } = useTranslation("accounting");
  const { canEdit, onCellEdit } = usePostingGroups("postingGroupSales");

  const balanceSheetAccountOptions = useMemo(() => {
    return balanceSheetAccounts.map((account) => ({
      label: account.number,
      value: account.number
    }));
  }, [balanceSheetAccounts]);

  const incomeStatementAccountOptions = useMemo(() => {
    return incomeStatementAccounts.map((account) => ({
      label: account.number,
      value: account.number
    }));
  }, [incomeStatementAccounts]);

  const columns = useMemo<ColumnDef<SalesPostingGroup>[]>(() => {
    return [
      {
        id: "itemPostingGroupId",
        header: t("postingGroup"),
        cell: ({ row }) => (
          <Enumerable
            value={
              itemPostingGroups.find(
                (group) => group.id === row.original.itemPostingGroupId
              )?.name ?? null
            }
          />
        ),
        meta: {
          filter: {
            type: "static",
            options: itemPostingGroups.map((group) => ({
              label: <Enumerable value={group.name} />,
              value: group.id
            }))
          }
        }
      },
      {
        id: "customerTypeId",
        header: t("customerType"),
        cell: ({ row }) => (
          <Enumerable
            value={
              customerTypes.find(
                (type) => type.id === row.original.customerTypeId
              )?.name ?? null
            }
          />
        ),
        meta: {
          filter: {
            type: "static",
            options: customerTypes.map((ct) => ({
              label: <Enumerable value={ct.name} />,
              value: ct.id
            }))
          }
        }
      },
      {
        accessorKey: "receivablesAccount",
        header: t("receivables"),
        cell: (item) => item.getValue()
      },
      {
        accessorKey: "salesAccount",
        header: t("sales"),
        cell: (item) => item.getValue()
      },
      {
        accessorKey: "salesDiscountAccount",
        header: t("salesDiscount"),
        cell: (item) => item.getValue()
      },
      {
        accessorKey: "salesCreditAccount",
        header: t("salesCredit"),
        cell: (item) => item.getValue()
      },
      {
        accessorKey: "salesPrepaymentAccount",
        header: t("salesPrepayment"),
        cell: (item) => item.getValue()
      },
      {
        accessorKey: "salesTaxPayableAccount",
        header: t("salesTaxPayable"),
        cell: (item) => item.getValue()
      }
    ];
  }, [customerTypes, itemPostingGroups, t]);

  const editableComponents = useMemo(
    () => ({
      receivablesAccount: EditableList(onCellEdit, balanceSheetAccountOptions),
      salesAccount: EditableList(onCellEdit, incomeStatementAccountOptions),
      salesDiscountAccount: EditableList(
        onCellEdit,
        incomeStatementAccountOptions
      ),
      salesCreditAccount: EditableList(onCellEdit, balanceSheetAccountOptions),
      salesPrepaymentAccount: EditableList(
        onCellEdit,
        balanceSheetAccountOptions
      ),
      salesTaxPayableAccount: EditableList(
        onCellEdit,
        balanceSheetAccountOptions
      )
    }),
    [onCellEdit, balanceSheetAccountOptions, incomeStatementAccountOptions]
  );

  return (
    <Table<SalesPostingGroup>
      data={data}
      columns={columns}
      count={count}
      editableComponents={editableComponents}
      withInlineEditing={canEdit}
      withSearch={false}
      title={t("salesPostingGroups")}
    />
  );
};

export default SalesPostingGroupsTable;
